{% extends "_default.html" %}

{% block title %}View Task {{ data['title'] }} {% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <h1> {{ data['title'] }} </h1>
    {{ data['text'] | safe }}
  </div>
</div>

<div class="row">
  <div class="col-lg-12">
    {% if not session['username'] %}
    <span class="red">You need to login to get test data and submit solution...</span>
    {% elif not test %}
    <span class="green">No checker for this task... strange... :)</span>
    {% else %}
    <form action="{{ url_for('tasks.task_check') }}" method="POST" onsubmit="return beforeSolutionSubmit()">
      {% if test[0] == 'plain' %}
      <div class="form-group">
        <label for="inputdata">Input Data:</label>
        <textarea id="inputdata" name="inputdata" class="form-control" rows="10">{{ test[1] | safe }}</textarea>
      </div>
      <div class="form-group">
        <label for="answer">Your Answer:</label>
        <input type="text" id="answer" name="answer" class="form-control" placeholder="your answer here">
      </div>
      {% elif test[0] == 'quiz' %}
      {% for q in test[1] %}
      <div>{{ q['q'] | safe }}
        <ul>
        {% for a in q['items'] %}
          <li><input name="{{ a.id }}" type="checkbox"/> <label for="{{ a.id }}">{{ a.text | safe }}</label></li>
        {% endfor %}
        </ul>
      </div>
      {% endfor %}
      {% else %}
      <span class="green">Checker of unknown type... strange... :)</span>
      {% endif %}
      <div class="form-group">
        <button type="submit" class="btn btn-primary">Submit</button>
      </div>
      {% if test[0] == 'plain' %}
      <div class="form-group">
        <label for="solution">Please, post Your code here:</label>
        <textarea id="solution" name="solution" class="form-control" rows="10"></textarea>
        <div id="solution-div" style="border: 1px solid #aaa; margin-bottom: 1rem;"/>
      </div>
      <div class="form-row">
        <div class="from-group col">
          <select class="form-control" id="language-select" name="language-select">
            {% for langkey in test[2] %}
            <option value="{{ langkey }}">{{ test[2][langkey] }}</option>
            {% endfor %}
          </select>
          <label class="small" for="language-select">Language select</label>
        </div>
        <div class="from-group col">
          <button class="btn btn-info d-block" id="run-code" type="button">Run on Server</button>
          <label class="small" for="run-code">execute with Hackerrank API</label>
        </div>
        <div class="from-group col">
          <button class="btn btn-warning d-block" id="load-solution" type="button" data-toggle="modal" data-target="#load-solution-modal">Load another</button>
          <label class="small" for="load-solution">(re)load existing solution</label>
        </div>
      </div>
      {% endif %}
    </form>
    <div class="modal fade" id="load-solution-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Your Stored Solutions</h5>
          </div>
          <div class="modal-body">
            <p>You have solutions in these languages:<br/><br/>
              <span id="solution-links"></span><br/>
              <span class="small">Clicking any of these will replace your current code with the stored version.<br/>
                Click "Close" if changed your mind.</span>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block more_scripts %}
{% if session['username'] %}

<script src="{{ url_for('static', filename = 'js/ace/ace.js') }}" type="text/javascript"></script>

<script>

function LanguageDetector() {
    function countCharacters(s) {
        var cnt = [];
        for (var i = 0; i < 256; i++) {
            cnt[i] = 0;
        }
        for (var j = 0; j < s.length; j++) {
            var c = s.charCodeAt(j);
            if (c >= 0 && c < 256) {
                cnt[i]++;
            }
        }
        return cnt;
    }

    this.detect = function(s) {
        var cnt = countCharacters(s);
        var len = s.length;
        var lenBf = s.replace(/[^\+\-\.\,\[\]\<\>\:\;\s]/g, '').length;
        if (lenBf / (len + 1) > 0.6 && s.indexOf('#include') < 0) {
            return 'bf';
        }
        if (s.indexOf('var ') >= 0) {
            return s.indexOf('using ') >= 0 ? 'cs' : 'js';
        }
        if (/\bdef\b/.test(s) && /\bend\b/.test(s)) {
            return 'ruby';
        }
        if (/with\s+ada/i.test(s)) {
            return 'ada';
        }
        if (/fn\s+main/.test(s)) {
            return 'rust';
        }
        var endLines = s.match(/[\,\;\{\}][\040\t]*[\n\r]/);
        endLines = endLines !== null ? endLines.length : 0;
        if (endLines / (cnt[10] + 1) > 0.4) {
            if (s.indexOf('#include') >= 0) {
                return 'cpp';
            }
            if (/main\s*\(\s*String/.test(s)) {
                return 'java';
            }
            if (cnt['$'.charCodeAt(0)] / len > 0.005) {
                return 'php';
            }
            return 'cs';
        } else {
            if (/\([\+\*]/.test(s)) {
                return 'lisp';
            }
            if (s.indexOf('dim ') >= 0) {
                return 'basic';
            }
            if (s.indexOf('local ') >= 0) {
                return 'lua';
            }
            return 'py';
        }
    }
}

var languageDetector = new LanguageDetector();

function findLanguageName(key) {
    return $('#language-select option[value=' + key + ']').text();
}

function beforeSolutionSubmit() {
    var solTextArea = $('#solution');
    if (solTextArea.length == 0) {
        return true;
    }
    var text = solTextArea.val();
    var detected = languageDetector.detect(text);
    var selected = $('#language-select').val();
    if (detected != selected) {
        return confirm('Are you sure your solution is in "'
            + findLanguageName(selected) + '" language?\n\n'
            + 'If not, click "Cancel" and choose proper language please...\n'
            + '(perhaps, "' + findLanguageName(detected) + '"?)');
    }
}

function reloadSolution(lang) {
    window.aceEditor.setValue(atob(window.storedSolutions[lang]));
    window.aceEditor.getSelection().selectFileStart();
    $('#language-select').val(lang).change();
}

function reloadSolutionLink(lang) {
    reloadSolution(lang);
    $('#load-solution-modal').modal('hide');
}

function changeEditorLanguage() {
    var lang = $('#language-select').val();
    switch (lang) {
        case "cpp": lang = "c_cpp";break;
        case "cs": lang = "csharp";break;
        case "java": lang = "java";break;
        case "js": lang = "javascript";break;
        case "py": lang = "python";break;
        case "ruby": lang = "ruby";break;
        case "scala": lang = "scala";break;
        default: lang = "plain_text";break;
    }
    aceEditor.getSession().setMode("ace/mode/" + lang);
}

function executeCode() {
    var data = {
        code: btoa($('#solution').val()),
        input: btoa($('#inputdata').val()),
        lang: $('#language-select').val(),
    };
    var runButton = $('#run-code');
    runButton.attr('disabled', 'true');
    var answerField = $('#answer');
    answerField.focus();
    answerField.val('please wait please wait ');
    var timer = setInterval(function(){
        var s = answerField.val();
        answerField.val(s.substring(1) + s[0]);
    }, 117);
    $.ajax({
        type: 'POST',
        url: "{{url_for('tools.run_code')}}",
        data: JSON.stringify(data),
        contentType: 'application/json',
        dataType: 'text',
        success: function(res) {
            clearInterval(timer);
            answerField.val(res);
            runButton.attr('disabled', null);
        }
    });
}

$(function() {
    $('#run-code').click(executeCode);
    var solutionTextarea = $('#solution');
    if (solutionTextarea.length > 0) {
        solutionTextarea.hide();
        window.aceEditor = ace.edit('solution-div', {
            minLines: 10,
            maxLines: 30,
            showPrintMargin: false,
            fontSize: '1rem',
            mode: 'ace/mode/plain_text',
        });
        window.aceEditor.getSession().on('change', function() {
            solutionTextarea.val(window.aceEditor.getSession().getValue());
        });
        $('#language-select').change(changeEditorLanguage);
        $.get("{{url_for('tasks.get_solution', taskid=data['id'])}}", function(data) {
            window.storedSolutions = data;
            var keys = Object.keys(data);
            var solLinksBody = $('#solution-links');
            for (var i in keys) {
                $('<a></a>').attr('href', '#').attr('onclick', 'reloadSolutionLink("' + keys[i] + '")')
                    .text(findLanguageName(keys[i])).appendTo(solLinksBody);
                solLinksBody.append(' ');
            }
            if (keys.length > 0) {
                var lang = keys[0];
                reloadSolution(lang);
            }
        });
    }
});

</script>
{% endif %}
{% endblock %}
